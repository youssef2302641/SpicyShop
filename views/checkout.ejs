<!-- Checkout Header -->
<section class="checkout-header">
    <h1>Checkout</h1>
    <p>Complete your purchase</p>
</section>

<!-- Checkout Content -->
<section class="checkout-content">
    <div class="checkout-grid">
        <!-- Order Summary -->
        <div class="order-summary">
            <h2>Order Summary</h2>
            <div id="checkoutItems">
                <!-- Items will be loaded here -->
            </div>
            <div class="summary-totals">
                <div class="summary-item">
                    <span>Subtotal:</span>
                    <span id="checkoutSubtotal">$0.00</span>
                </div>
                <div class="summary-item">
                    <span>Shipping:</span>
                    <span id="checkoutShipping">$0.00</span>
                </div>
                <div class="summary-item">
                    <span>Tax:</span>
                    <span id="checkoutTax">$0.00</span>
                </div>
                <div class="summary-item total">
                    <span>Total:</span>
                    <span id="checkoutTotal">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Checkout Form -->
        <div class="checkout-form">
            <form id="checkoutForm" action="/checkout/process" method="POST">
                <!-- Shipping Information -->
                <div class="form-section">
                    <h3>Shipping Information</h3>
                    <div class="form-group">
                        <label for="street">Street Address</label>
                        <input type="text" id="street" name="street" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode">ZIP Code</label>
                            <input type="text" id="zipCode" name="zipCode" required>
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" name="country" required>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="form-section">
                    <h3>Payment Information</h3>
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" name="cardNumber" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry">Expiry Date</label>
                            <input type="text" id="expiry" name="expiry" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" name="cvv" required>
                        </div>
                    </div>
                </div>

                <div id="error-message" class="error-message" style="display: none; color: red; margin-bottom: 1rem;"></div>
                <button type="submit" class="btn btn-primary">Place Order</button>
            </form>
        </div>
    </div>
</section>

<!-- Add Stripe Elements -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const checkoutItems = document.getElementById('checkoutItems');
        const errorMessage = document.getElementById('error-message');
        const submitButton = document.querySelector('button[type="submit"]');
        
        if (cart.length === 0) {
            window.location.href = '/cart';
            return;
        }

        // Create checkout items HTML
        const itemsHTML = cart.map(item => `
            <div class="checkout-item">
                <img src="${item.image}" alt="${item.name}" class="checkout-item-img">
                <div class="checkout-item-details">
                    <h4>${item.name}</h4>
                    <p>Size: ${item.size}</p>
                    <p>Quantity: ${item.quantity}</p>
                    <p>$${(item.price * item.quantity).toFixed(2)}</p>
                </div>
            </div>
        `).join('');
        
        checkoutItems.innerHTML = itemsHTML;
        
        // Calculate totals
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal > 0 ? 10 : 0;
        const tax = subtotal * 0.1;
        const total = subtotal + shipping + tax;
        
        // Update summary
        document.getElementById('checkoutSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('checkoutShipping').textContent = `$${shipping.toFixed(2)}`;
        document.getElementById('checkoutTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('checkoutTotal').textContent = `$${total.toFixed(2)}`;

        // Handle form submission
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Reset error message
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            
            // Disable submit button
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            try {
                const formData = new FormData(this);
                const orderData = {
                    items: cart,
                    shippingAddress: {
                        street: formData.get('street'),
                        city: formData.get('city'),
                        state: formData.get('state'),
                        zipCode: formData.get('zipCode'),
                        country: formData.get('country')
                    },
                    paymentMethod: 'card',
                    totalAmount: parseFloat(document.getElementById('checkoutTotal').textContent.replace('$', ''))
                };

                console.log('Sending order data:', orderData);

                const response = await fetch('/checkout/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();
                console.log('Server response:', data);

                if (response.ok) {
                    localStorage.removeItem('cart');
                    window.location.href = '/checkout/success';
                } else {
                    throw new Error(data.error || 'Failed to process order');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = error.message || 'There was an error processing your order. Please try again.';
                errorMessage.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Place Order';
            }
        });
    });
</script>

<style>
    .checkout {
        padding: 2rem 0;
    }

    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .order-summary {
        background: #f8f8f8;
        padding: 1.5rem;
        border-radius: 8px;
    }

    .checkout-item {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #ddd;
    }

    .checkout-item-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 1rem;
    }

    .checkout-item-details {
        flex: 1;
    }

    .summary-totals {
        margin-top: 1.5rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .summary-item.total {
        font-weight: bold;
        font-size: 1.2rem;
        border-top: 1px solid #ddd;
        padding-top: 1rem;
        margin-top: 1rem;
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
    }

    input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .error-message {
        color: #ff4444;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: 4px;
        background-color: #fff5f5;
        border: 1px solid #ffdddd;
    }

    button[type="submit"] {
        width: 100%;
        padding: 1rem;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1rem;
    }

    button[type="submit"]:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }

    button[type="submit"]:hover:not(:disabled) {
        background: #ff2222;
    }
</style> 